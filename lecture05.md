# Лекция 5

## Выбор плана выполнения запроса
Пишем exmplain/analize в SQL и получаем план запроса в текстовом виде.

Мы можем влиять на план запроса:

1) можем переписать запрос: поменять SELECT

2) мы можем задавать hint'ы, чтобы влиять на генерацию плана запроса. В каждой системе они свои. Hint'ы могут говорить о том, какой тип join'а использовать, как использовать индексы и т.д. Бывают hint'ы на подзапросы, выборку и т.д.

## Оператор проекции

Его можно применять на любом этапе. Подход полезный, т.к. позволяет откидывать часть данных при соединении, например.

## Агрегация

Пример запроса: 

```
SELECT skill. avg(wage), exp FROM wages GROUP BY skill;
```

Как делать? Проходимся по таблице и делаем map'у. Делаем это за один проход.
Агрегация почти всегда делается в конце запроса. Данных, как правило, после агрегации, становится мало.

## Сортировки

Они очень сильно помогают, если правильно отсортировать, то можем получить выигрыш в производительности. Но налету делать не можем, а делать каждый раз это -- долго. Мораль -- люди берегут сортировку. Цель сортировки сделать так, чтобы долго не бегать по таблице.

Иногда планировщики не делают хэщ-джоин, чтобы сохранить сортировку, и делает это для оптимизации. Nested-loop, кстати, сохраняет сортировку.

## Замечания про запросы

Операторы бывают блокирующими и не блокирующими(hash-join). А ещё они могут ломать сортировку или нет.

Тут мы завершаем разговор про движки.

## SQL

Начинался ка часть проекта System-R(сделана IBM). У SQL были стандарты: 86, 89, 92(есть в открытом доступе, за остальные надо пойти, но стандарты у конкретных БД свои, беспокоиться не стоит), 99(рекурсивные запросы -- будем разбирать), 03(оконные функции), 06, 08, 19, 19, 23.

SQL можно подмешивать в код языка программирования, например в C. Это называется встроенным SQL. Как это сделано на C не знаю, как-будто бы это макросы.

Это раньше, сейчас есть нормальные библиотеки.


## DDL
DDL позволяет задавать схему отношения, типа данных атрибутов, индексы и т.д.

Типов больше чем в каком-либо языке программирования. Это наследие прошлого. Дело в том, что код баз данных живёт больше кодов программ.

Задание схемы: 

```
create table dep
    (varchar(32) name)
```

Также DLL позволяет устанавливать ограничения целостности, своего рода assertations.

## DML

Команды: insert, update, delete, drop; drop table r, и т.д.

## SELECT

Базовая команда, говорит, какие атрибуты надо выбрать. Пример:

```
select dept_name from instructor;
```
Изначально дубликаты не удаляет, если надо их удалить, то пишем 
```
select distinct dept_name from instructor;
```

Можем накладывать ограничения с помощью where, где прописываем условие:
 ```
 select name
 from instructor
 where dept_name = 'CS' and salary > 300000;
 ```
 ## JOIN

 получаем данные из нескольких таблиц: перечисляем в from таблицы, которые хотим объединить.

 ## Общая схема

 ```
 select A1, A2, ..., AN
 from R1, R2, ..., RN
 WHERE PREDICATE;
 ```

 Вычисляется оно в циклах, где перебираются кортежи.

 ## Multiset algebra

 В жизни нужны дубликаты, а в реляционной модели их нет, тогда придумали алгебры мультимножеств.